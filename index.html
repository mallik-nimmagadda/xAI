import React, { useState, useEffect, useRef } from 'react';
import { Bird, Trophy, Gamepad2, Send, Bot, Activity, Terminal, Sparkles, X, MessageSquare, Loader2, Zap, Heart, Footprints, Dumbbell, Wind, CalendarRange, User, Settings, Shield, Bell, Smartphone, LogOut, Edit3, Save, Eye, UploadCloud, Layers, PlayCircle, ScanFace, FileText, CheckCircle2, Flame, TrendingUp, Utensils, LayoutDashboard, FlaskConical, BrainCircuit, SplitSquareHorizontal, BookOpen } from 'lucide-react';

// --- Types ---
type Tab = 'dashboard' | 'playground' | 'profile' | 'birdielab' | 'tutorials';
type TimeRange = 'week' | 'month';

type Message = {
  role: 'user' | 'model';
  content: string;
};

type PlayerData = {
  id: string;
  name: string;
  recovery: number; // 0-100% (Green/Yellow/Red)
  strain: number;   // 0-21
  sleep: number;    // 0-100% Performance
  hrv: number;      // ms
  vo2max: number;   // ml/kg/min
  grip: number;     // Score 0-100
  strokes: number;  // Score 0-100
  footwork: number; // Score 0-100
  speed: number;    // Score 0-100
  status: 'peak' | 'recovering' | 'fatigued';
};

type UserProfile = {
  name: string;
  email: string;
  age: number;
  height: string;
  weight: string;
  hand: 'Right' | 'Left';
  racket: string;
  tension: string;
  shoes: string;
};

// --- Mock Data ---
const INITIAL_PLAYER_DATA: PlayerData[] = [
  { 
    id: 'p1', 
    name: 'Viktor A.', 
    recovery: 88, // Green
    strain: 18.4, // High strain
    sleep: 92,
    hrv: 145,
    vo2max: 68,
    grip: 94,
    strokes: 98,
    footwork: 95,
    speed: 91,
    status: 'peak'
  },
  { 
    id: 'p2', 
    name: 'Lee Z. J.', 
    recovery: 45, // Yellow
    strain: 12.2,
    sleep: 76,
    hrv: 89,
    vo2max: 62,
    grip: 96,
    strokes: 92,
    footwork: 88,
    speed: 95,
    status: 'recovering'
  },
  { 
    id: 'p3', 
    name: 'Kento M.', 
    recovery: 22, // Red
    strain: 19.8,
    sleep: 54,
    hrv: 55,
    vo2max: 65,
    grip: 88,
    strokes: 99,
    footwork: 92,
    speed: 85,
    status: 'fatigued'
  },
];

const INITIAL_PROFILE: UserProfile = {
  name: "Viktor Axelsen",
  email: "viktor.a@birdiex.ai",
  age: 29,
  height: "194 cm",
  weight: "88 kg",
  hand: "Right",
  racket: "Yonex Astrox 100ZZ",
  tension: "31 lbs",
  shoes: "Yonex Power Cushion 65Z"
};

// --- Gemini API Integration (Chat) ---
const generateBirdieResponse = async (
  userQuery: string,
  chatHistory: Message[],
  currentTab: Tab,
  playerData: PlayerData[],
  playgroundContent: string,
  userProfile: UserProfile
): Promise<string> => {
  const apiKey = ""; // Injected at runtime
  
  let contextData = "";
  if (currentTab === 'dashboard') {
    contextData = JSON.stringify(playerData);
  } else if (currentTab === 'profile') {
    contextData = JSON.stringify(userProfile);
  } else if (currentTab === 'birdielab') {
    contextData = "User is in BirdieLab (Video Analysis mode). Mock data: Reference video loaded (Smash Technique). Player video loaded. Backend analysis shows 15% deviation in elbow angle.";
  } else if (currentTab === 'tutorials') {
    contextData = "User is browsing the Tutorials Library. Available modules: Smash Mastery, Net Play Secrets, Defensive Footwork, Advanced Serve Tactics.";
  } else {
    contextData = `Playground Input: ${playgroundContent || "Empty"}`;
  }

  const systemPrompt = `
    You are Birdie-Coach, an expert Badminton Performance Analyst and Coach for the BirdieXAI platform.
    Current User View: ${currentTab === 'dashboard' ? 'Birdie-Dashboard (Main Dashboard)' : currentTab === 'birdielab' ? 'BirdieLab (Motion Analysis)' : currentTab === 'tutorials' ? 'Tutorials Library' : currentTab}
    Current Data Context: ${contextData}
    Role: Analyze athlete data, provide training advice, and be encouraging using badminton terminology.
  `;

  const recentHistory = chatHistory.slice(-10).map(msg => ({
    role: msg.role === 'user' ? 'user' : 'model',
    parts: [{ text: msg.content }]
  }));

  const payload = {
    contents: [...recentHistory, { parts: [{ text: userQuery }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] }
  };

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }
    );
    if (!response.ok) throw new Error('API request failed');
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Coach is offline.";
  } catch (error) {
    return "My coaching link is down.";
  }
};

// --- Gemini API Integration (Smart Features) ---
const generateSmartFeature = async (
  prompt: string,
  systemContext: string
): Promise<string> => {
  const apiKey = ""; // Injected at runtime
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    systemInstruction: { parts: [{ text: systemContext }] }
  };

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }
    );
    if (!response.ok) throw new Error('API request failed');
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis failed.";
  } catch (error) {
    return "Feature unavailable.";
  }
};

// --- Helper Components ---

const CircularMetric = ({ value, max = 100, label, subtext, colorClass, size = "md" }: { value: number, max?: number, label: string, subtext: string, colorClass: string, size?: "sm" | "md" }) => {
  const radius = size === "md" ? 50 : 36;
  const stroke = size === "md" ? 8 : 6;
  const dimension = size === "md" ? 120 : 90;
  const circumference = 2 * Math.PI * radius;
  const strokeDashoffset = circumference - (value / max) * circumference;

  return (
    <div className="flex flex-col items-center justify-center">
      <div className="relative flex items-center justify-center" style={{ width: dimension, height: dimension }}>
        <svg className="w-full h-full transform -rotate-90 drop-shadow-lg">
          <circle cx="50%" cy="50%" r={radius} stroke="currentColor" strokeWidth={stroke} fill="transparent" className="text-slate-800" />
          <circle cx="50%" cy="50%" r={radius} stroke="currentColor" strokeWidth={stroke} fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" className={`transition-all duration-1000 ease-out ${colorClass}`} />
        </svg>
        <div className="absolute flex flex-col items-center">
          <span className={`font-bold font-mono text-white ${size === 'md' ? 'text-3xl' : 'text-xl'}`}>
            {value}{max === 21 ? '' : '%'}
          </span>
        </div>
      </div>
      <div className="text-center mt-2">
        <div className="text-sm font-semibold text-slate-200">{label}</div>
        <div className="text-[10px] uppercase tracking-wider text-slate-500 font-medium">{subtext}</div>
      </div>
    </div>
  );
};

const MetricCard = ({ label, value, unit, icon: Icon }: any) => (
  <div className="bg-slate-900 border border-slate-800 p-4 rounded-xl flex items-center justify-between group hover:border-slate-700 transition-colors">
    <div>
      <div className="text-xs text-slate-500 font-medium uppercase tracking-wide mb-1 flex items-center gap-1">
        {Icon && <Icon className="w-3 h-3 text-teal-500" />} {label}
      </div>
      <div className="flex items-baseline gap-1">
        <span className="text-2xl font-mono font-bold text-white group-hover:text-teal-400 transition-colors">{value}</span>
        <span className="text-xs text-slate-400 font-mono">{unit}</span>
      </div>
    </div>
  </div>
);

// --- Components ---

const DashboardView = ({ data }: { data: PlayerData[] }) => {
  const [activePlayerId, setActivePlayerId] = useState(data[0].id);
  const [timeRange, setTimeRange] = useState<TimeRange>('week');
  
  // AI Feature States
  const [trainingPlan, setTrainingPlan] = useState<string | null>(null);
  const [isGeneratingPlan, setIsGeneratingPlan] = useState(false);
  const [trendAnalysis, setTrendAnalysis] = useState<string | null>(null);
  const [isAnalyzingTrends, setIsAnalyzingTrends] = useState(false);
  const [recoveryProtocol, setRecoveryProtocol] = useState<string | null>(null);
  const [isGeneratingRecovery, setIsGeneratingRecovery] = useState(false);
  
  const activePlayer = data.find(p => p.id === activePlayerId) || data[0];

  const handleGeneratePlan = async () => {
    setIsGeneratingPlan(true);
    setRecoveryProtocol(null); // Clear other results to avoid clutter
    const prompt = `
      Player: ${activePlayer.name}
      Recovery: ${activePlayer.recovery}%
      Strain: ${activePlayer.strain}
      Sleep: ${activePlayer.sleep}%
      Status: ${activePlayer.status}
      
      Generate a concise, 3-part daily training schedule (Morning, Afternoon, Evening) specifically tailored to these metrics. 
      If recovery is low, prescribe rest or light technical work. If recovery is high, suggest high intensity. 
      Format with bullet points and emojis. Keep it short.
    `;
    const system = "You are an elite high-performance badminton coach.";
    
    const result = await generateSmartFeature(prompt, system);
    setTrainingPlan(result);
    setIsGeneratingPlan(false);
  };

  const handleRecoveryProtocol = async () => {
    setIsGeneratingRecovery(true);
    setTrainingPlan(null); // Clear other results
    const prompt = `
      Generate a personalized recovery protocol for ${activePlayer.name}.
      Metrics: Strain ${activePlayer.strain} (High), Recovery ${activePlayer.recovery}%, Sleep ${activePlayer.sleep}%.
      
      Suggest:
      1. Nutrition: Specific post-workout meal or supplement advice.
      2. Physical: One specific modality (e.g., contrast bath, foam rolling specific muscle groups).
      3. Mental: A brief wind-down technique.
      
      Keep it actionable and brief.
    `;
    const system = "You are a sports physiotherapist and nutrition expert.";
    const result = await generateSmartFeature(prompt, system);
    setRecoveryProtocol(result);
    setIsGeneratingRecovery(false);
  };

  const handleAnalyzeTrends = async () => {
    setIsAnalyzingTrends(true);
    const prompt = `
      Analyze the activity load patterns for ${activePlayer.name} over the last ${timeRange}.
      Current Strain: ${activePlayer.strain}
      Current Recovery: ${activePlayer.recovery}%
      
      Assume the graph shows a "sawtooth" pattern of high strain followed by incomplete recovery.
      Provide a "Data Insight" identifying if this is functional overreaching or risk of burnout.
      Keep it to 2 insightful sentences.
    `;
    const system = "You are a sports data scientist.";
    const result = await generateSmartFeature(prompt, system);
    setTrendAnalysis(result);
    setIsAnalyzingTrends(false);
  };

  const getReadinessColor = (val: number) => {
    if (val >= 67) return "text-emerald-500";
    if (val >= 34) return "text-amber-400";
    return "text-rose-500";
  };

  return (
    <div className="flex flex-col lg:flex-row gap-6 animate-in fade-in duration-500 h-full">
      {/* Main Dashboard - Left Side */}
      <div className="flex-1 space-y-6">
        
        {/* Top Rings Section */}
        <div className="bg-slate-950 border border-slate-800 p-6 rounded-2xl shadow-xl bg-gradient-to-b from-slate-900/50 to-slate-950">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
              <Activity className="w-4 h-4" /> Daily Biometrics
            </h3>
            <span className="text-xs font-mono text-slate-500">{new Date().toLocaleDateString()}</span>
          </div>
          
          <div className="flex flex-col md:flex-row justify-around items-center gap-8 py-4">
            <CircularMetric value={activePlayer.strain} max={21} label="Strain" subtext="Day Strain" colorClass="text-blue-500" size="md" />
            <CircularMetric value={activePlayer.recovery} max={100} label="Recovery" subtext={activePlayer.recovery >= 67 ? "Primed" : activePlayer.recovery >= 34 ? "Recovering" : "Rest Needed"} colorClass={getReadinessColor(activePlayer.recovery)} size="md" />
            <CircularMetric value={activePlayer.sleep} max={100} label="Sleep" subtext="Performance" colorClass="text-indigo-400" size="md" />
          </div>
        </div>

        {/* Detailed Metrics */}
        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest px-1">Performance Stats</h3>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
          <MetricCard label="Grip Strength" value={activePlayer.grip} unit="kg" icon={Dumbbell} />
          <MetricCard label="Strokes Quality" value={activePlayer.strokes} unit="/100" icon={Wind} />
          <MetricCard label="Footwork" value={activePlayer.footwork} unit="/100" icon={Footprints} />
          <MetricCard label="Court Speed" value={activePlayer.speed} unit="score" icon={Zap} />
          <MetricCard label="HRV" value={activePlayer.hrv} unit="ms" icon={Heart} />
          <MetricCard label="VO2 Max" value={activePlayer.vo2max} unit="ml/kg" icon={Activity} />
        </div>

        {/* Activity Load Graph */}
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-lg relative overflow-hidden group">
          <div className="flex justify-between items-center mb-6">
             <div className="flex items-center gap-4">
                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                  <CalendarRange className="w-4 h-4" /> Activity Load
                </h3>
                <button 
                  onClick={handleAnalyzeTrends}
                  disabled={isAnalyzingTrends}
                  className="bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 text-[10px] uppercase font-bold px-2 py-1 rounded-md border border-indigo-500/20 flex items-center gap-1 transition-all"
                >
                  {isAnalyzingTrends ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />}
                  Analyze Trends
                </button>
             </div>
             
             <div className="flex bg-slate-950 p-1 rounded-lg border border-slate-800">
               <button onClick={() => setTimeRange('week')} className={`px-3 py-1 text-xs font-medium rounded transition-all ${timeRange === 'week' ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>Week</button>
               <button onClick={() => setTimeRange('month')} className={`px-3 py-1 text-xs font-medium rounded transition-all ${timeRange === 'month' ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>Month</button>
             </div>
          </div>
          
          {trendAnalysis && (
            <div className="mb-4 bg-indigo-900/20 border border-indigo-500/30 p-3 rounded-lg text-xs text-indigo-200 animate-in fade-in slide-in-from-top-2 flex gap-2 items-start">
               <TrendingUp className="w-4 h-4 shrink-0 mt-0.5" />
               <p>{trendAnalysis}</p>
            </div>
          )}

          <div className="h-40 w-full flex items-end justify-between gap-2 px-2">
             {Array.from({ length: timeRange === 'week' ? 7 : 30 }).map((_, i) => {
               const heightPct = (Math.random() * 100);
               const rec = Math.random() * 100;
               const colorClass = rec >= 67 ? 'bg-emerald-500' : rec >= 34 ? 'bg-amber-400' : 'bg-rose-500';
               return (
                 <div key={i} className="flex-1 flex flex-col justify-end items-center group/bar h-full">
                    <div className={`w-full rounded-t-sm opacity-80 group-hover/bar:opacity-100 transition-all duration-300 ${colorClass}`} style={{ height: `${heightPct}%` }} />
                 </div>
               );
             })}
          </div>
        </div>

        {/* Stress Monitor */}
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-lg relative overflow-hidden">
          <div className="flex justify-between items-center mb-6">
             <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
               <Flame className="w-4 h-4 text-rose-500" /> Stress Monitor
             </h3>
             <div className="flex items-center gap-2 bg-slate-950 px-2 py-1 rounded-lg border border-slate-800">
                 <span className="text-[10px] text-rose-500 font-mono font-bold animate-pulse">LIVE</span>
                 <div className="h-3 w-px bg-slate-800" />
                 <span className="text-[10px] text-slate-400 font-mono">HRV: 145ms</span>
             </div>
          </div>
          
          <div className="relative h-48 w-full bg-slate-950/50 rounded-xl overflow-hidden border border-slate-800/50">
             {/* Background Zones */}
             <div className="absolute inset-0 flex flex-col opacity-10">
                <div className="flex-1 bg-rose-600 border-b border-white/5"></div>
                <div className="flex-1 bg-amber-500 border-b border-white/5"></div>
                <div className="flex-1 bg-teal-500 border-b border-white/5"></div>
                <div className="flex-1 bg-blue-500"></div>
             </div>

             {/* Graph Line */}
             <svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                 <defs>
                   <linearGradient id="stressGradient" x1="0" y1="0" x2="0" y2="1">
                     <stop offset="0%" stopColor="#e11d48" stopOpacity="0.6" />
                     <stop offset="50%" stopColor="#f59e0b" stopOpacity="0.4" />
                     <stop offset="100%" stopColor="#14b8a6" stopOpacity="0.2" />
                   </linearGradient>
                 </defs>
                 <path d="M0,80 C10,75 20,40 30,30 S40,20 50,45 S60,85 70,80 S80,30 90,25 S100,50 100,50 L100,100 L0,100 Z" fill="url(#stressGradient)" />
                 <path d="M0,80 C10,75 20,40 30,30 S40,20 50,45 S60,85 70,80 S80,30 90,25 S100,50 100,50" fill="none" stroke="#fb7185" strokeWidth="0.5" strokeLinecap="round" />
             </svg>
             
             {/* Zone Labels */}
             <div className="absolute right-2 top-2 flex flex-col items-end gap-8 text-[8px] font-bold text-slate-600 select-none pointer-events-none">
                 <span className="text-rose-500/50">HIGH STRESS</span>
                 <span className="text-amber-500/50">MEDIUM</span>
                 <span className="text-teal-500/50">LOW</span>
                 <span className="text-blue-500/50">REST</span>
             </div>
             
             {/* Current Indicator Line */}
             <div className="absolute right-[10%] top-0 bottom-0 w-px bg-white/20 border-r border-dashed border-white/20">
                <div className="absolute top-[50%] -left-[3px] w-2 h-2 rounded-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)]" />
             </div>
          </div>
          
          <div className="flex justify-between mt-3 text-[10px] text-slate-500 font-mono uppercase tracking-wide px-1">
             <span>12:00 PM</span>
             <span>Current</span>
          </div>
        </div>
      </div>

      {/* Right Side - Coach Insight */}
      <div className="lg:w-80 flex flex-col gap-6">
        <div className="bg-slate-900 border border-slate-800 p-5 rounded-2xl shadow-lg flex-1 overflow-y-auto">
             <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <Bot className="w-4 h-4 text-indigo-400" /> Coach Insight
             </h3>
             
             <div className="bg-indigo-500/10 border border-indigo-500/20 p-4 rounded-lg mb-4">
                <p className="text-sm text-indigo-200 leading-relaxed">
                  <span className="font-bold block mb-2 text-white">Daily Focus: {activePlayer.name}</span>
                  {activePlayer.recovery < 40 
                    ? "Low recovery. Prioritize sleep hygiene and light drills."
                    : activePlayer.strain > 18
                    ? "High strain. Ensure adequate protein intake and stretching."
                    : "Primed for peak performance. Focus: High-intensity intervals."}
                </p>
             </div>

             <div className="border-t border-slate-800 pt-4 space-y-3">
               {/* AI Feature: Smart Plan */}
               <button 
                 onClick={handleGeneratePlan}
                 disabled={isGeneratingPlan}
                 className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white p-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20"
               >
                 {isGeneratingPlan ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
                 Generate Smart Plan
               </button>
               
               {/* AI Feature: Recovery Protocol */}
               <button 
                 onClick={handleRecoveryProtocol}
                 disabled={isGeneratingRecovery}
                 className="w-full bg-slate-800 hover:bg-slate-700 text-teal-400 p-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all border border-slate-700"
               >
                 {isGeneratingRecovery ? <Loader2 className="w-4 h-4 animate-spin" /> : <Utensils className="w-4 h-4" />}
                 Get Recovery Protocol
               </button>
               
               {trainingPlan && (
                 <div className="mt-4 bg-slate-950 p-4 rounded-lg border border-slate-800 animate-in fade-in slide-in-from-top-2">
                   <h4 className="text-xs font-bold text-purple-400 uppercase mb-2">Personalized Schedule</h4>
                   <div className="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed">
                     {trainingPlan}
                   </div>
                 </div>
               )}

               {recoveryProtocol && (
                 <div className="mt-4 bg-slate-950 p-4 rounded-lg border border-slate-800 animate-in fade-in slide-in-from-top-2">
                   <h4 className="text-xs font-bold text-teal-400 uppercase mb-2">Recovery Protocol</h4>
                   <div className="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed">
                     {recoveryProtocol}
                   </div>
                 </div>
               )}
             </div>
        </div>
      </div>
    </div>
  );
};

const BirdieLabView = () => {
  const [refUploaded, setRefUploaded] = useState(false);
  const [playerUploaded, setPlayerUploaded] = useState(false);
  const [processing, setProcessing] = useState(false);
  const [analyzed, setAnalyzed] = useState(false);
  
  // AI Feature State
  const [drillFixes, setDrillFixes] = useState<string | null>(null);
  const [isGeneratingDrills, setIsGeneratingDrills] = useState(false);
  const [aiComparison, setAiComparison] = useState<string | null>(null);
  const [isComparing, setIsComparing] = useState(false);
  const [mentalCue, setMentalCue] = useState<string | null>(null);
  const [isGeneratingCue, setIsGeneratingCue] = useState(false);

  const handleSimulateAnalysis = () => {
    if (!refUploaded || !playerUploaded) return;
    setProcessing(true);
    setTimeout(() => {
      setProcessing(false);
      setAnalyzed(true);
    }, 2500);
  };

  const handleGetFixes = async () => {
    setIsGeneratingDrills(true);
    const prompt = `
      The computer vision system analyzed a badminton smash.
      Finding: The player's elbow angle is 82 degrees at contact (Ideal is 95+ degrees).
      Result: Reduced power and higher risk of injury.
      
      Act as a biomechanics expert. Briefly explain WHY this matters, then list 3 specific, actionable corrective drills to fix this "low elbow" error.
    `;
    const system = "You are an expert badminton biomechanist and coach.";
    const result = await generateSmartFeature(prompt, system);
    setDrillFixes(result);
    setIsGeneratingDrills(false);
  };

  const handleAiCompare = async () => {
    setIsComparing(true);
    const prompt = `
      Compare these two badminton players based on the motion analysis data:
      
      Reference Model (Pro):
      - Elbow Angle: 98° (Optimal)
      - Contact Point: Highest reach
      - Racket Speed: 312 km/h
      
      Player (User):
      - Elbow Angle: 82° (Too low)
      - Contact Point: Slightly dropped
      - Racket Speed: 245 km/h
      
      Provide a concise, 3-point comparative analysis explaining exactly what the user is losing (power, angle, control) due to these mechanical differences.
    `;
    const system = "You are a biomechanics expert analyzing sports video.";
    const result = await generateSmartFeature(prompt, system);
    setAiComparison(result);
    setIsComparing(false);
  }

  const handleMentalCue = async () => {
    setIsGeneratingCue(true);
    const prompt = `
      The badminton player is dropping their elbow during a smash (82° instead of 95°+).
      Generate 3 short, punchy "Mental Cues" or mantras they can say to themselves before serving to remind them to keep the elbow high. 
      Examples: "Reach for the sky", "Elbow above ear".
      Make them catchy.
    `;
    const system = "You are a sports psychologist.";
    const result = await generateSmartFeature(prompt, system);
    setMentalCue(result);
    setIsGeneratingCue(false);
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full animate-in fade-in duration-500">
      
      {/* Column 1: Upload Controls */}
      <div className="flex flex-col gap-6 h-full">
        {/* Row 1: Upload Reference */}
        <div onClick={() => setRefUploaded(true)} className={`flex-1 rounded-2xl p-6 border-2 border-dashed transition-all cursor-pointer group flex flex-col items-center justify-center ${refUploaded ? 'bg-indigo-900/20 border-indigo-500/50' : 'bg-slate-900 border-slate-700 hover:border-indigo-400 hover:bg-slate-800'}`}>
          {refUploaded ? (
            <>
               <div className="w-16 h-16 bg-indigo-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/30"><PlayCircle className="w-8 h-8 text-white" /></div>
               <h3 className="text-lg font-bold text-indigo-300">Reference Loaded</h3>
               <p className="text-xs text-slate-400 mt-1">Lee_Smash_V2.mp4 (4K)</p>
            </>
          ) : (
            <>
               <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 group-hover:bg-slate-700 transition-colors"><UploadCloud className="w-8 h-8 text-slate-400 group-hover:text-indigo-400 transition-colors" /></div>
               <h3 className="text-lg font-bold text-slate-300 group-hover:text-white">Upload Reference</h3>
               <p className="text-xs text-slate-500 mt-1">Drag pro footage here</p>
            </>
          )}
        </div>

        {/* Row 2: Upload Player */}
        <div onClick={() => setPlayerUploaded(true)} className={`flex-1 rounded-2xl p-6 border-2 border-dashed transition-all cursor-pointer group flex flex-col items-center justify-center ${playerUploaded ? 'bg-teal-900/20 border-teal-500/50' : 'bg-slate-900 border-slate-700 hover:border-teal-400 hover:bg-slate-800'}`}>
          {playerUploaded ? (
            <>
               <div className="w-16 h-16 bg-teal-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-teal-500/30"><ScanFace className="w-8 h-8 text-white" /></div>
               <h3 className="text-lg font-bold text-teal-300">Player Loaded</h3>
               <p className="text-xs text-slate-400 mt-1">My_Practice_Session.mp4</p>
            </>
          ) : (
            <>
               <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 group-hover:bg-slate-700 transition-colors"><UploadCloud className="w-8 h-8 text-slate-400 group-hover:text-teal-400 transition-colors" /></div>
               <h3 className="text-lg font-bold text-slate-300 group-hover:text-white">Upload Player</h3>
               <p className="text-xs text-slate-500 mt-1">Drag your training video here</p>
            </>
          )}
        </div>
      </div>

      {/* Column 2: Backend Visualization */}
      <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 flex flex-col relative overflow-hidden shadow-xl">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold text-white flex items-center gap-2"><Eye className="w-5 h-5 text-indigo-400" /> Motion Analysis</h3>
          <div className="flex items-center gap-2"><div className="text-[10px] font-mono text-slate-500 uppercase tracking-wider">Powered by GCP Vertex AI</div><div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" /></div>
        </div>
        
        <div className="flex-1 bg-black/50 rounded-xl border border-slate-800 flex flex-col relative overflow-hidden group">
          <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:20px_20px]" />
          
          {analyzed ? (
             <div className="flex-1 flex flex-col relative overflow-y-auto">
                <div className="flex h-64 border-b border-slate-800">
                  <div className="w-1/2 border-r border-slate-700 flex flex-col items-center justify-center relative">
                      <svg className="w-24 h-36 opacity-80" viewBox="0 0 100 200">
                         <circle cx="50" cy="30" r="10" stroke="cyan" strokeWidth="2" fill="none" />
                         <line x1="50" y1="40" x2="50" y2="100" stroke="cyan" strokeWidth="2" />
                         <line x1="50" y1="50" x2="90" y2="40" stroke="cyan" strokeWidth="2" />
                         <line x1="50" y1="100" x2="30" y2="160" stroke="cyan" strokeWidth="2" />
                         <line x1="50" y1="100" x2="70" y2="160" stroke="cyan" strokeWidth="2" />
                      </svg>
                      <div className="absolute top-2 left-2 text-[10px] bg-cyan-900/50 text-cyan-300 px-2 rounded">REF MODEL</div>
                  </div>
                  <div className="w-1/2 flex flex-col items-center justify-center relative">
                      <svg className="w-24 h-36 opacity-80" viewBox="0 0 100 200">
                         <circle cx="50" cy="30" r="10" stroke="magenta" strokeWidth="2" fill="none" />
                         <line x1="50" y1="40" x2="50" y2="100" stroke="magenta" strokeWidth="2" />
                         <line x1="50" y1="50" x2="80" y2="50" stroke="magenta" strokeWidth="2" /> 
                         <line x1="50" y1="100" x2="30" y2="160" stroke="magenta" strokeWidth="2" />
                         <line x1="50" y1="100" x2="70" y2="160" stroke="magenta" strokeWidth="2" />
                      </svg>
                      <div className="absolute top-2 right-2 text-[10px] bg-pink-900/50 text-pink-300 px-2 rounded">YOU</div>
                      <div className="absolute top-[30%] right-[20%] w-6 h-6 border-2 border-red-500 rounded-full animate-ping" />
                  </div>
                </div>
                
                <div className="bg-slate-900/90 p-4 space-y-4">
                   {/* Key Metric Highlight */}
                   <div className="flex justify-between items-center pb-2 border-b border-slate-800">
                      <div>
                        <div className="text-[10px] text-slate-400">Arm Angle Deviation</div>
                        <div className="text-sm font-mono text-red-400">82° <span className="text-[10px] text-slate-500">(Ideal: 95°)</span></div>
                      </div>
                      <div className="flex gap-2">
                        <button 
                           onClick={handleGetFixes}
                           disabled={isGeneratingDrills}
                           className="bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1 transition-all"
                        >
                           {isGeneratingDrills ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />}
                           Fix This Flaw
                        </button>
                      </div>
                   </div>
                   
                   {drillFixes && (
                      <div className="bg-slate-950 border border-indigo-500/30 rounded-lg p-3 text-xs text-slate-300 font-mono whitespace-pre-wrap animate-in fade-in slide-in-from-bottom-2">
                        {drillFixes}
                      </div>
                   )}

                   {/* Additional AI Tools */}
                   <div className="grid grid-cols-2 gap-2">
                      <button 
                         onClick={handleAiCompare}
                         disabled={isComparing}
                         className="bg-slate-800 hover:bg-slate-700 text-teal-400 text-xs px-3 py-2 rounded flex items-center justify-center gap-1 transition-all border border-slate-700"
                      >
                         {isComparing ? <Loader2 className="w-3 h-3 animate-spin" /> : <SplitSquareHorizontal className="w-3 h-3" />}
                         AI Comparative Analysis
                      </button>
                      <button 
                         onClick={handleMentalCue}
                         disabled={isGeneratingCue}
                         className="bg-slate-800 hover:bg-slate-700 text-pink-400 text-xs px-3 py-2 rounded flex items-center justify-center gap-1 transition-all border border-slate-700"
                      >
                         {isGeneratingCue ? <Loader2 className="w-3 h-3 animate-spin" /> : <BrainCircuit className="w-3 h-3" />}
                         Generate Mental Cues
                      </button>
                   </div>

                   {/* Comparison Result */}
                   {aiComparison && (
                      <div className="bg-slate-950 border border-teal-500/30 rounded-lg p-3 text-xs text-slate-300 font-mono whitespace-pre-wrap animate-in fade-in slide-in-from-bottom-2">
                        <strong className="text-teal-400 block mb-1">Coach's Comparison:</strong>
                        {aiComparison}
                      </div>
                   )}

                   {/* Mental Cue Result */}
                   {mentalCue && (
                      <div className="bg-slate-950 border border-pink-500/30 rounded-lg p-3 text-xs text-slate-300 font-mono whitespace-pre-wrap animate-in fade-in slide-in-from-bottom-2">
                        <strong className="text-pink-400 block mb-1">Focus Mantras:</strong>
                        {mentalCue}
                      </div>
                   )}
                </div>
             </div>
          ) : processing ? (
            <div className="flex-1 flex flex-col items-center justify-center gap-4">
              <Loader2 className="w-12 h-12 text-indigo-500 animate-spin" />
              <div className="text-center space-y-1">
                 <p className="text-indigo-300 font-medium">Processing Skeletal Data...</p>
                 <p className="text-xs text-slate-500">Connecting to Cloud Inference Nodes</p>
              </div>
            </div>
          ) : (
             <div className="flex-1 flex flex-col items-center justify-center text-slate-600 gap-3 p-8 text-center">
                <Layers className="w-16 h-16 opacity-30" />
                <p>Upload both videos to initiate comparison.</p>
                <button 
                  onClick={handleSimulateAnalysis}
                  disabled={!refUploaded || !playerUploaded}
                  className="mt-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-800 disabled:text-slate-500 text-white px-6 py-2 rounded-lg font-medium transition-all"
                >
                   {refUploaded && playerUploaded ? "Run Cloud Analysis" : "Waiting for Uploads..."}
                </button>
             </div>
          )}
        </div>
      </div>
    </div>
  );
};

const TutorialsView = () => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500 h-full overflow-y-auto pb-4">
       {/* Placeholder cards for tutorials */}
       {['Smash Mechanics', 'Net Drop Mastery', 'Defensive Footwork', 'Serve Tactics', 'Double Strategy', 'Recovery Yoga', 'Backhand Clear', 'Mental Game'].map((title, i) => (
         <div key={i} className="bg-slate-900 border border-slate-800 p-4 rounded-xl group hover:border-indigo-500/50 transition-all cursor-pointer flex flex-col">
            <div className="aspect-video bg-slate-800 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent opacity-60" />
                <div className="absolute inset-0 flex items-center justify-center">
                   <PlayCircle className="w-12 h-12 text-white/50 group-hover:text-indigo-400 group-hover:scale-110 transition-all z-10" />
                </div>
            </div>
            <h3 className="font-bold text-slate-200 group-hover:text-indigo-300 transition-colors">{title}</h3>
            <p className="text-xs text-slate-500 mt-1 flex items-center gap-2">
               <span>10 min</span>
               <span className="w-1 h-1 bg-slate-700 rounded-full" />
               <span>Pro Level</span>
            </p>
         </div>
       ))}
    </div>
  );
};

const PlaygroundView = ({ 
  input, 
  setInput, 
  onSimulate, 
  simulationResult, 
  isSimulating 
}: { 
  input: string, 
  setInput: (s: string) => void, 
  onSimulate: () => void, 
  simulationResult: string | null,
  isSimulating: boolean
}) => {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full animate-in fade-in duration-500">
      <div className="flex flex-col h-full bg-slate-800 border border-slate-700 p-6 rounded-2xl shadow-xl">
        <h3 className="text-xl font-bold text-pink-400 mb-4 flex items-center gap-2">
          <Terminal className="w-5 h-5" /> Match Strategy Simulator
        </h3>
        <textarea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="Describe opponent (e.g., 'Aggressive smash player, weak backhand defense')..."
          className="flex-1 w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-slate-200 focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 font-mono resize-none transition-all placeholder:text-slate-600"
        />
        <div className="mt-4 flex justify-between items-center">
          <span className="text-xs text-slate-500">{input.length} characters</span>
          <button 
            onClick={onSimulate}
            disabled={!input || isSimulating}
            className="bg-pink-600 hover:bg-pink-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium transition-all flex items-center gap-2 shadow-lg shadow-pink-900/20"
          >
            {isSimulating ? <Loader2 className="w-4 h-4 animate-spin" /> : <Gamepad2 className="w-4 h-4" />}
            Simulate Match
          </button>
        </div>
      </div>

      <div className="flex flex-col h-full bg-slate-800 border border-slate-700 p-6 rounded-2xl shadow-xl">
        <h3 className="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
          <Bot className="w-5 h-5" /> Tactical Analysis
        </h3>
        <div className="flex-1 bg-slate-950 rounded-xl p-6 border border-slate-800 overflow-y-auto font-mono">
          {simulationResult ? (
            <div className="text-slate-300 whitespace-pre-wrap animate-in slide-in-from-bottom-2">
              {simulationResult}
            </div>
          ) : (
            <div className="h-full flex flex-col items-center justify-center text-slate-600">
              <Zap className="w-12 h-12 mb-2 opacity-50" />
              <p>Ready to analyze opponent...</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const ProfileView = ({ profile, setProfile }: { profile: UserProfile, setProfile: (p: UserProfile) => void }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [tempProfile, setTempProfile] = useState(profile);

  const handleSave = () => {
    setProfile(tempProfile);
    setIsEditing(false);
  };

  const handleChange = (field: keyof UserProfile, value: string | number) => {
    setTempProfile(prev => ({ ...prev, [field]: value }));
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full animate-in fade-in duration-500 overflow-y-auto">
      {/* Profile Card */}
      <div className="lg:col-span-1 space-y-6">
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-xl flex flex-col items-center text-center">
          <div className="w-32 h-32 rounded-full bg-gradient-to-br from-teal-500 to-indigo-600 p-1 mb-4 shadow-xl shadow-indigo-500/20">
            <div className="w-full h-full rounded-full bg-slate-900 flex items-center justify-center overflow-hidden">
               <Bird className="w-16 h-16 text-indigo-400" />
            </div>
          </div>
          <h2 className="text-2xl font-bold text-white">{profile.name}</h2>
          <p className="text-indigo-400 text-sm font-medium mb-4">Pro Athlete</p>
          
          <div className="grid grid-cols-3 gap-2 w-full mt-2">
             <div className="bg-slate-950 p-2 rounded-lg border border-slate-800">
               <div className="text-xs text-slate-500">Rank</div>
               <div className="font-mono text-white">#1</div>
             </div>
             <div className="bg-slate-950 p-2 rounded-lg border border-slate-800">
               <div className="text-xs text-slate-500">Age</div>
               <div className="font-mono text-white">{profile.age}</div>
             </div>
             <div className="bg-slate-950 p-2 rounded-lg border border-slate-800">
               <div className="text-xs text-slate-500">Hand</div>
               <div className="font-mono text-white">{profile.hand}</div>
             </div>
          </div>
        </div>

        {/* Gear Settings */}
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-xl">
           <div className="flex justify-between items-center mb-4">
             <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                <Dumbbell className="w-4 h-4" /> Gear Setup
             </h3>
             <button onClick={() => setIsEditing(!isEditing)} className="text-indigo-400 hover:text-indigo-300">
               {isEditing ? <Save className="w-4 h-4" onClick={handleSave} /> : <Edit3 className="w-4 h-4" />}
             </button>
           </div>
           
           <div className="space-y-4">
              <div>
                <label className="text-xs text-slate-500 block mb-1">Racket Model</label>
                {isEditing ? (
                  <input type="text" value={tempProfile.racket} onChange={(e) => handleChange('racket', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-indigo-500" />
                ) : (
                  <div className="text-sm text-slate-200 font-medium">{profile.racket}</div>
                )}
              </div>
              <div>
                <label className="text-xs text-slate-500 block mb-1">String Tension</label>
                {isEditing ? (
                  <input type="text" value={tempProfile.tension} onChange={(e) => handleChange('tension', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-indigo-500" />
                ) : (
                  <div className="text-sm text-slate-200 font-medium">{profile.tension}</div>
                )}
              </div>
              <div>
                <label className="text-xs text-slate-500 block mb-1">Shoe Preference</label>
                {isEditing ? (
                  <input type="text" value={tempProfile.shoes} onChange={(e) => handleChange('shoes', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-indigo-500" />
                ) : (
                  <div className="text-sm text-slate-200 font-medium">{profile.shoes}</div>
                )}
              </div>
           </div>
        </div>
      </div>

      {/* Main Settings Panel */}
      <div className="lg:col-span-2 space-y-6">
        
        {/* Physical Stats */}
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-xl">
           <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
              <Activity className="w-4 h-4" /> Physical Profile
           </h3>
           <div className="grid grid-cols-2 gap-6">
              <div className="p-4 bg-slate-950 rounded-xl border border-slate-800 flex items-center gap-4">
                 <div className="w-10 h-10 rounded-full bg-teal-500/20 flex items-center justify-center text-teal-500">
                    <Activity className="w-5 h-5" />
                 </div>
                 <div>
                    <div className="text-xs text-slate-500">Height</div>
                    <div className="text-lg font-bold text-white">{profile.height}</div>
                 </div>
              </div>
              <div className="p-4 bg-slate-950 rounded-xl border border-slate-800 flex items-center gap-4">
                 <div className="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-500">
                    <Dumbbell className="w-5 h-5" />
                 </div>
                 <div>
                    <div className="text-xs text-slate-500">Weight</div>
                    <div className="text-lg font-bold text-white">{profile.weight}</div>
                 </div>
              </div>
           </div>
        </div>

        {/* App Settings */}
        <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-xl">
           <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
              <Settings className="w-4 h-4" /> Application Settings
           </h3>
           
           <div className="space-y-4">
              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-slate-800/50 transition-colors">
                 <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400">
                       <Bell className="w-4 h-4" />
                    </div>
                    <div>
                       <div className="text-sm font-medium text-slate-200">Push Notifications</div>
                       <div className="text-xs text-slate-500">Receive recovery alerts</div>
                    </div>
                 </div>
                 <div className="w-10 h-5 bg-teal-500 rounded-full relative cursor-pointer">
                    <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full shadow-sm" />
                 </div>
              </div>

              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-slate-800/50 transition-colors">
                 <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400">
                       <Smartphone className="w-4 h-4" />
                    </div>
                    <div>
                       <div className="text-sm font-medium text-slate-200">Device Integration</div>
                       <div className="text-xs text-slate-500">Connected to Whoop 4.0</div>
                    </div>
                 </div>
                 <div className="text-xs font-bold text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded">CONNECTED</div>
              </div>

              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-slate-800/50 transition-colors">
                 <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400">
                       <Shield className="w-4 h-4" />
                    </div>
                    <div>
                       <div className="text-sm font-medium text-slate-200">Privacy Mode</div>
                       <div className="text-xs text-slate-500">Hide stats from public roster</div>
                    </div>
                 </div>
                 <div className="w-10 h-5 bg-slate-700 rounded-full relative cursor-pointer">
                    <div className="absolute left-1 top-1 w-3 h-3 bg-slate-400 rounded-full shadow-sm" />
                 </div>
              </div>

              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-rose-900/10 transition-colors cursor-pointer group">
                 <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-rose-500 group-hover:bg-rose-500/20">
                       <LogOut className="w-4 h-4" />
                    </div>
                    <div>
                       <div className="text-sm font-medium text-rose-500">Sign Out</div>
                    </div>
                 </div>
              </div>
           </div>
        </div>

      </div>
    </div>
  );
};

// --- Main App ---

export default function BirdieXAI() {
  const [activeTab, setActiveTab] = useState<Tab>('dashboard');
  const [chatOpen, setChatOpen] = useState(true);
  const [inputMessage, setInputMessage] = useState('');
  const [chatHistory, setChatHistory] = useState<Message[]>([
    { role: 'model', content: "Chirp! I'm Birdie-Coach. I see your player stats. Need advice on training load or match strategy?" }
  ]);
  const [isTyping, setIsTyping] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);

  // Data States
  const [playerData, setPlayerData] = useState<PlayerData[]>(INITIAL_PLAYER_DATA);
  const [userProfile, setUserProfile] = useState<UserProfile>(INITIAL_PROFILE);

  // Playground State
  const [pgInput, setPgInput] = useState('');
  const [pgResult, setPgResult] = useState<string | null>(null);
  const [isSimulating, setIsSimulating] = useState(false);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatHistory, chatOpen]);

  const handleSendMessage = async () => {
    if (!inputMessage.trim()) return;

    const userMsg: Message = { role: 'user', content: inputMessage };
    setChatHistory(prev => [...prev, userMsg]);
    setInputMessage('');
    setIsTyping(true);

    const responseText = await generateBirdieResponse(
      inputMessage,
      [...chatHistory, userMsg],
      activeTab,
      playerData,
      pgInput,
      userProfile
    );

    setChatHistory(prev => [...prev, { role: 'model', content: responseText }]);
    setIsTyping(false);
  };

  const runSimulation = () => {
    setIsSimulating(true);
    setTimeout(() => {
      const mockResponses = [
        "Analysis Complete.\n\nStrategy: Keep shuttles low to neutralize smash.\nTarget: Opponent's backhand rear court.\nWin Probability: 65%",
        "Warning: Opponent excels at net play.\n\nCounter-tactic: Use deceptive flicks and push to baseline to force them back.",
        "Simulation Result:\n\nHigh pace rallies detected.\nRecommended Focus: Maintain stamina, avoid unforced errors in first 5 shots."
      ];
      setPgResult(mockResponses[Math.floor(Math.random() * mockResponses.length)]);
      setIsSimulating(false);
    }, 1500);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-teal-500/30 selection:text-teal-200 overflow-hidden flex flex-col">
      
      {/* Header */}
      <header className="h-16 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md flex items-center px-6 z-20">
        <div className="flex items-center gap-3 mr-auto">
          <div className="w-10 h-10 bg-gradient-to-br from-teal-400 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg shadow-teal-500/20">
            <Bird className="text-white w-6 h-6" />
          </div>
          <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-indigo-400 tracking-tight">
            BirdieXAI
          </h1>
        </div>

        <nav className="flex gap-2 bg-slate-800/50 p-1 rounded-lg mr-4">
          <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'dashboard' ? 'bg-slate-700 text-teal-400 shadow-sm' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}><LayoutDashboard className="w-4 h-4" /> Dashboard</button>
          <button onClick={() => setActiveTab('birdielab')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'birdielab' ? 'bg-slate-700 text-teal-400 shadow-sm' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}><FlaskConical className="w-4 h-4" /> BirdieLab</button>
          <button onClick={() => setActiveTab('tutorials')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'tutorials' ? 'bg-slate-700 text-teal-400 shadow-sm' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}><BookOpen className="w-4 h-4" /> Tutorials</button>
          <button onClick={() => setActiveTab('playground')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'playground' ? 'bg-slate-700 text-pink-400 shadow-sm' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}><Gamepad2 className="w-4 h-4" /> Playground</button>
          <button onClick={() => setActiveTab('profile')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'profile' ? 'bg-slate-700 text-indigo-400 shadow-sm' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}><User className="w-4 h-4" /> Profile</button>
        </nav>

        <div className="flex justify-end">
           <button onClick={() => setActiveTab('profile')} className="text-slate-400 hover:text-white transition-colors"><Settings className="w-5 h-5" /></button>
        </div> 
      </header>

      {/* Main Content Area */}
      <main className="flex-1 relative overflow-hidden flex">
        
        {/* Workspace */}
        <div className={`flex-1 overflow-y-auto p-6 transition-all duration-300 ${chatOpen ? 'mr-[400px]' : ''}`}>
          <div className="max-w-6xl mx-auto h-full">
            <div className="mb-6">
              <h2 className="text-3xl font-light text-slate-100">
                <span className="font-semibold text-white">
                    {activeTab === 'dashboard' ? 'Performance Dashboard' : activeTab === 'profile' ? 'My Profile' : activeTab === 'birdielab' ? 'BirdieLab' : activeTab === 'tutorials' ? 'Birdie Tutorials' : 'Tactical Arena'}
                </span>
              </h2>
              <p className="text-slate-400 mt-1 text-sm">
                {activeTab === 'dashboard' 
                  ? 'Track metrics, recovery status, and physiological load.'
                  : activeTab === 'profile'
                  ? 'Manage your athlete profile, gear settings, and preferences.'
                  : activeTab === 'birdielab'
                  ? 'Compare your technique against pro references using AI Motion Analysis.'
                  : activeTab === 'tutorials'
                  ? 'Master advanced techniques with expert-led video guides and drills.'
                  : 'Simulate match scenarios, test prompts, and develop winning strategies.'}
              </p>
            </div>

            {activeTab === 'dashboard' ? (
              <DashboardView data={playerData} />
            ) : activeTab === 'profile' ? (
              <ProfileView profile={userProfile} setProfile={setUserProfile} />
            ) : activeTab === 'birdielab' ? (
              <BirdieLabView />
            ) : activeTab === 'tutorials' ? (
              <TutorialsView />
            ) : (
              <PlaygroundView 
                input={pgInput} 
                setInput={setPgInput} 
                onSimulate={runSimulation}
                simulationResult={pgResult}
                isSimulating={isSimulating}
              />
            )}
          </div>
        </div>

        {/* Birdie-Coach Panel */}
        <div className={`fixed right-0 top-16 bottom-0 w-[400px] bg-slate-900 border-l border-slate-800 shadow-2xl flex flex-col transition-transform duration-300 z-30 ${chatOpen ? 'translate-x-0' : 'translate-x-full'}`}>
          {/* Coach Header */}
          <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/90 backdrop-blur">
            <div className="flex items-center gap-3">
              <div className="relative">
                <div className="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center border-2 border-slate-800 shadow-lg"><Bird className="w-5 h-5 text-white" /></div>
                <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full border-2 border-slate-900 animate-pulse" />
              </div>
              <div>
                <h3 className="font-bold text-slate-100">Birdie-Coach</h3>
                <p className="text-xs text-indigo-300 flex items-center gap-1"><Sparkles className="w-3 h-3" /> Coach Active</p>
              </div>
            </div>
            <button onClick={() => setChatOpen(false)} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"><X className="w-5 h-5" /></button>
          </div>

          {/* Chat Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
            {chatHistory.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] rounded-2xl p-3 text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none'}`}>{msg.content}</div>
              </div>
            ))}
            {isTyping && (
              <div className="flex justify-start">
                <div className="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none p-4 flex gap-2 items-center">
                  <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" />
                  <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-75" />
                  <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-150" />
                </div>
              </div>
            )}
            <div ref={chatEndRef} />
          </div>

          {/* Chat Input */}
          <div className="p-4 bg-slate-900 border-t border-slate-800">
            <div className="relative">
              <input type="text" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="Ask Coach about stats..." className="w-full bg-slate-950 border border-slate-700 text-slate-200 rounded-xl py-3 pl-4 pr-12 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder:text-slate-600" />
              <button onClick={handleSendMessage} disabled={!inputMessage.trim() || isTyping} className="absolute right-2 top-2 p-1.5 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg transition-colors"><Send className="w-4 h-4" /></button>
            </div>
            <div className="text-center mt-2"><p className="text-[10px] text-slate-600">Birdie-Coach uses your biometrics to give specific advice.</p></div>
          </div>
        </div>

        {/* Floating Chat Toggle */}
        {!chatOpen && (
          <button onClick={() => setChatOpen(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-2xl flex items-center justify-center transition-all hover:scale-110 z-40">
            <MessageSquare className="w-6 h-6" />
            <span className="absolute -top-1 -right-1 flex h-4 w-4">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-4 w-4 bg-emerald-500"></span>
            </span>
          </button>
        )}
      </main>
    </div>
  );
}